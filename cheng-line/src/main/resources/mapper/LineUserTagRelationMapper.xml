<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cheng.line.mapper.LineUserTagRelationMapper">

    <resultMap type="com.cheng.line.domain.LineUserTagRelation" id="LineUserTagRelationResult">
        <id     property="id"              column="id"/>
        <result property="lineUserId"      column="line_user_id"/>
        <result property="tagId"           column="tag_id"/>
        <result property="createBy"        column="create_by"/>
        <result property="createTime"      column="create_time"/>
        <result property="tagName"         column="tag_name"/>
        <result property="tagColor"        column="tag_color"/>
        <result property="lineDisplayName" column="line_display_name"/>
    </resultMap>

    <sql id="selectLineUserTagRelationVo">
        select r.id, r.line_user_id, r.tag_id, r.create_by, r.create_time,
               t.tag_name, t.tag_color,
               u.line_display_name
        from line_user_tag_relation r
        left join sys_tag t on r.tag_id = t.tag_id
        left join line_user u on r.line_user_id = u.line_user_id
    </sql>

    <select id="selectLineUserTagRelationById" parameterType="Long" resultMap="LineUserTagRelationResult">
        <include refid="selectLineUserTagRelationVo"/>
        where r.id = #{id}
    </select>

    <select id="selectByLineUserId" parameterType="String" resultMap="LineUserTagRelationResult">
        <include refid="selectLineUserTagRelationVo"/>
        where r.line_user_id = #{lineUserId}
        order by r.create_time desc
    </select>

    <select id="selectByTagId" parameterType="Long" resultMap="LineUserTagRelationResult">
        <include refid="selectLineUserTagRelationVo"/>
        where r.tag_id = #{tagId}
        order by r.create_time desc
    </select>

    <select id="selectLineUserTagRelationList" parameterType="com.cheng.line.domain.LineUserTagRelation" resultMap="LineUserTagRelationResult">
        <include refid="selectLineUserTagRelationVo"/>
        <where>
            <if test="lineUserId != null and lineUserId != ''">
                AND r.line_user_id = #{lineUserId}
            </if>
            <if test="tagId != null">
                AND r.tag_id = #{tagId}
            </if>
            <if test="tagName != null and tagName != ''">
                AND t.tag_name like concat('%', #{tagName}, '%')
            </if>
            <if test="lineDisplayName != null and lineDisplayName != ''">
                AND u.line_display_name like concat('%', #{lineDisplayName}, '%')
            </if>
        </where>
        order by r.create_time desc
    </select>

    <select id="checkRelationExists" resultMap="LineUserTagRelationResult">
        select r.id, r.line_user_id, r.tag_id, r.create_by, r.create_time
        from line_user_tag_relation r
        where r.line_user_id = #{lineUserId} and r.tag_id = #{tagId}
        limit 1
    </select>

    <select id="countUsersByTagId" parameterType="Long" resultType="int">
        select count(*) from line_user_tag_relation where tag_id = #{tagId}
    </select>

    <insert id="insertLineUserTagRelation" parameterType="com.cheng.line.domain.LineUserTagRelation" useGeneratedKeys="true" keyProperty="id">
        insert into line_user_tag_relation
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="lineUserId != null and lineUserId != ''">line_user_id,</if>
            <if test="tagId != null">tag_id,</if>
            <if test="createBy != null and createBy != ''">create_by,</if>
            create_time
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="lineUserId != null and lineUserId != ''">#{lineUserId},</if>
            <if test="tagId != null">#{tagId},</if>
            <if test="createBy != null and createBy != ''">#{createBy},</if>
            sysdate()
        </trim>
    </insert>

    <insert id="batchInsertLineUserTagRelation" parameterType="java.util.List">
        insert ignore into line_user_tag_relation (line_user_id, tag_id, create_by, create_time)
        values
        <foreach collection="list" item="item" separator=",">
            (#{item.lineUserId}, #{item.tagId}, #{item.createBy}, sysdate())
        </foreach>
    </insert>

    <delete id="deleteLineUserTagRelationById" parameterType="Long">
        delete from line_user_tag_relation where id = #{id}
    </delete>

    <delete id="deleteByUserIdAndTagId">
        delete from line_user_tag_relation where line_user_id = #{lineUserId} and tag_id = #{tagId}
    </delete>

    <delete id="deleteByLineUserId" parameterType="String">
        delete from line_user_tag_relation where line_user_id = #{lineUserId}
    </delete>

    <delete id="deleteByTagId" parameterType="Long">
        delete from line_user_tag_relation where tag_id = #{tagId}
    </delete>

    <delete id="deleteLineUserTagRelationByIds" parameterType="Long">
        delete from line_user_tag_relation where id in
        <foreach collection="array" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <select id="selectByLineUserIds" resultMap="LineUserTagRelationResult">
        <include refid="selectLineUserTagRelationVo"/>
        where r.line_user_id in
        <foreach collection="lineUserIds" item="lineUserId" open="(" separator="," close=")">
            #{lineUserId}
        </foreach>
        order by r.line_user_id, r.create_time desc
    </select>

    <insert id="batchInsertIgnore" parameterType="java.util.List">
        insert ignore into line_user_tag_relation (line_user_id, tag_id, create_by, create_time)
        values
        <foreach collection="relations" item="item" separator=",">
            (#{item.lineUserId}, #{item.tagId}, #{item.createBy}, sysdate())
        </foreach>
    </insert>

</mapper>
