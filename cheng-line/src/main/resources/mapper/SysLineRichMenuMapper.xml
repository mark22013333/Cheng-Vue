<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cheng.line.mapper.SysLineRichMenuMapper">

    <resultMap type="SysLineRichMenu" id="SysLineRichMenuResult">
        <id property="id" column="id"/>
        <result property="configId" column="config_id"/>
        <result property="name" column="name"/>
        <result property="description" column="description"/>
        <result property="templateTypeCode" column="template_type"/>
        <result property="chatBarText" column="chat_bar_text"/>
        <result property="imageUrl" column="image_url"/>
        <result property="localImagePath" column="local_image_path"/>
        <result property="imageSize" column="image_size"/>
        <result property="isDefault" column="is_default"/>
        <result property="selected" column="selected"/>
        <result property="statusCode" column="status"/>
        <result property="richMenuId" column="rich_menu_id"/>
        <result property="suggestedAliasId" column="suggested_alias_id"/>
        <result property="previousRichMenuId" column="previous_rich_menu_id"/>
        <result property="previousConfig" column="previous_config"/>
        <result property="areasJson" column="areas_json"/>
        <result property="version" column="version"/>
        <result property="createBy" column="create_by"/>
        <result property="createTime" column="create_time"/>
        <result property="updateBy" column="update_by"/>
        <result property="updateTime" column="update_time"/>
        <result property="remark" column="remark"/>
    </resultMap>

    <!-- 關聯查詢結果映射（包含頻道資訊） -->
    <resultMap type="SysLineRichMenu" id="SysLineRichMenuWithConfigResult" extends="SysLineRichMenuResult">
        <result property="channelName" column="channel_name"/>
        <association property="lineConfig" javaType="LineConfig">
            <id property="configId" column="config_id"/>
            <result property="channelName" column="channel_name"/>
            <result property="botBasicId" column="bot_basic_id"/>
            <result property="channelTypeCode" column="channel_type"/>
        </association>
    </resultMap>

    <sql id="selectSysLineRichMenuVo">
        select r.id,
               r.config_id,
               r.name,
               r.description,
               r.template_type,
               r.chat_bar_text,
               r.image_url,
               r.local_image_path,
               r.image_size,
               r.is_default,
               r.selected,
               r.status,
               r.rich_menu_id,
               r.suggested_alias_id,
               r.previous_rich_menu_id,
               r.previous_config,
               r.areas_json,
               r.version,
               r.create_by,
               r.create_time,
               r.update_by,
               r.update_time,
               r.remark
        from sys_line_rich_menu r
    </sql>

    <sql id="selectSysLineRichMenuWithConfigVo">
        select r.id,
               r.config_id,
               r.name,
               r.description,
               r.template_type,
               r.chat_bar_text,
               r.image_url,
               r.local_image_path,
               r.image_size,
               r.is_default,
               r.selected,
               r.status,
               r.rich_menu_id,
               r.suggested_alias_id,
               r.previous_rich_menu_id,
               r.previous_config,
               r.areas_json,
               r.version,
               r.create_by,
               r.create_time,
               r.update_by,
               r.update_time,
               r.remark,
               c.channel_name,
               c.bot_basic_id,
               c.channel_type
        from sys_line_rich_menu r
                 left join sys_line_config c on r.config_id = c.config_id
    </sql>

    <select id="selectRichMenuList" parameterType="SysLineRichMenu" resultMap="SysLineRichMenuWithConfigResult">
        <include refid="selectSysLineRichMenuWithConfigVo"/>
        <where>
            <if test="configId != null">and r.config_id = #{configId}</if>
            <if test="name != null and name != ''">and r.name like concat('%', #{name}, '%')</if>
            <if test="templateType != null">and r.template_type = #{templateTypeCode}</if>
            <if test="status != null">and r.status = #{statusCode}</if>
            <if test="isDefault != null">and r.is_default = #{isDefault}</if>
            <if test="selected != null">and r.selected = #{selected}</if>
            <if test="richMenuId != null and richMenuId != ''">and r.rich_menu_id = #{richMenuId}</if>
            <if test="params.beginTime != null and params.beginTime != ''">
                and date_format(r.create_time,'%y%m%d') &gt;= date_format(#{params.beginTime},'%y%m%d')
            </if>
            <if test="params.endTime != null and params.endTime != ''">
                and date_format(r.create_time,'%y%m%d') &lt;= date_format(#{params.endTime},'%y%m%d')
            </if>
        </where>
        order by r.is_default desc, r.selected desc, r.create_time desc
    </select>

    <select id="selectRichMenuById" parameterType="Long" resultMap="SysLineRichMenuWithConfigResult">
        <include refid="selectSysLineRichMenuWithConfigVo"/>
        where r.id = #{id}
    </select>

    <select id="selectRichMenuByRichMenuId" parameterType="String" resultMap="SysLineRichMenuResult">
        <include refid="selectSysLineRichMenuVo"/>
        where r.rich_menu_id = #{richMenuId}
        limit 1
    </select>

    <select id="selectDefaultRichMenuByConfigId" parameterType="Integer" resultMap="SysLineRichMenuResult">
        <include refid="selectSysLineRichMenuVo"/>
        where r.config_id = #{configId}
          and r.is_default = 1
        limit 1
    </select>

    <select id="selectSelectedRichMenuByConfigId" parameterType="Integer" resultMap="SysLineRichMenuResult">
        <include refid="selectSysLineRichMenuVo"/>
        where r.config_id = #{configId}
          and r.selected = 1
        limit 1
    </select>

    <insert id="insertRichMenu" parameterType="SysLineRichMenu" useGeneratedKeys="true" keyProperty="id">
        insert into sys_line_rich_menu
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="configId != null">config_id,</if>
            <if test="name != null and name != ''">name,</if>
            <if test="description != null">description,</if>
            <if test="templateType != null">template_type,</if>
            <if test="chatBarText != null">chat_bar_text,</if>
            <if test="imageUrl != null">image_url,</if>
            <if test="localImagePath != null">local_image_path,</if>
            <if test="imageSize != null and imageSize != ''">image_size,</if>
            <if test="isDefault != null">is_default,</if>
            <if test="selected != null">selected,</if>
            <if test="status != null">status,</if>
            <if test="richMenuId != null">rich_menu_id,</if>
            <if test="suggestedAliasId != null and suggestedAliasId != ''">suggested_alias_id,</if>
            <if test="areasJson != null">areas_json,</if>
            <if test="version != null">version,</if>
            <if test="createBy != null">create_by,</if>
            <if test="remark != null">remark,</if>
            create_time
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="configId != null">#{configId},</if>
            <if test="name != null and name != ''">#{name},</if>
            <if test="description != null">#{description},</if>
            <if test="templateType != null">#{templateTypeCode},</if>
            <if test="chatBarText != null">#{chatBarText},</if>
            <if test="imageUrl != null">#{imageUrl},</if>
            <if test="localImagePath != null">#{localImagePath},</if>
            <if test="imageSize != null and imageSize != ''">#{imageSize},</if>
            <if test="isDefault != null">#{isDefault},</if>
            <if test="selected != null">#{selected},</if>
            <if test="status != null">#{statusCode},</if>
            <if test="richMenuId != null">#{richMenuId},</if>
            <if test="suggestedAliasId != null and suggestedAliasId != ''">#{suggestedAliasId},</if>
            <if test="areasJson != null">#{areasJson},</if>
            <if test="version != null">#{version},</if>
            <if test="createBy != null">#{createBy},</if>
            <if test="remark != null">#{remark},</if>
            sysdate()
        </trim>
    </insert>

    <update id="updateRichMenu" parameterType="SysLineRichMenu">
        update sys_line_rich_menu
        <trim prefix="SET" suffixOverrides=",">
            <if test="configId != null">config_id = #{configId},</if>
            <if test="name != null and name != ''">name = #{name},</if>
            <if test="description != null">description = #{description},</if>
            <if test="templateType != null">template_type = #{templateTypeCode},</if>
            <if test="chatBarText != null">chat_bar_text = #{chatBarText},</if>
            <if test="imageUrl != null">image_url = #{imageUrl},</if>
            <if test="localImagePath != null">local_image_path = #{localImagePath},</if>
            <if test="imageSize != null and imageSize != ''">image_size = #{imageSize},</if>
            <if test="isDefault != null">is_default = #{isDefault},</if>
            <if test="selected != null">selected = #{selected},</if>
            <if test="status != null">status = #{statusCode},</if>
            <if test="richMenuId != null">rich_menu_id = #{richMenuId},</if>
            <if test="suggestedAliasId != null">suggested_alias_id = #{suggestedAliasId},</if>
            <if test="areasJson != null">areas_json = #{areasJson},</if>
            <if test="version != null">version = #{version},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="remark != null">remark = #{remark},</if>
            update_time = sysdate()
        </trim>
        where id = #{id}
    </update>

    <delete id="deleteRichMenuById" parameterType="Long">
        delete
        from sys_line_rich_menu
        where id = #{id}
    </delete>

    <delete id="deleteRichMenuByIds" parameterType="Long">
        delete from sys_line_rich_menu where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <update id="unsetAllDefaultByConfigId" parameterType="Integer">
        update sys_line_rich_menu
        set is_default  = 0,
            update_time = sysdate()
        where config_id = #{configId}
          and is_default = 1
    </update>

    <update id="unsetAllSelectedByConfigId" parameterType="Integer">
        update sys_line_rich_menu
        set selected    = 0,
            update_time = sysdate()
        where config_id = #{configId}
          and selected = 1
    </update>

    <update id="setDefaultById" parameterType="Long">
        update sys_line_rich_menu
        set is_default  = 1,
            update_time = sysdate()
        where id = #{id}
    </update>

    <update id="setSelectedById" parameterType="Long">
        update sys_line_rich_menu
        set selected    = 1,
            update_time = sysdate()
        where id = #{id}
    </update>

    <update id="updateRichMenuId">
        update sys_line_rich_menu
        set rich_menu_id = #{richMenuId},
            update_time  = sysdate()
        where id = #{id}
    </update>

    <update id="updateStatus">
        update sys_line_rich_menu
        set status      = #{status},
            update_time = sysdate()
        where id = #{id}
    </update>

    <select id="checkNameUnique" resultMap="SysLineRichMenuResult">
        <include refid="selectSysLineRichMenuVo"/>
        where r.config_id = #{configId}
        and r.name = #{name}
        <if test="excludeId != null">
            and r.id != #{excludeId}
        </if>
        limit 1
    </select>

    <update id="updatePublishInfo">
        update sys_line_rich_menu
        set rich_menu_id          = #{richMenuId},
            previous_rich_menu_id = #{previousRichMenuId},
            previous_config       = #{previousConfig},
            local_image_path      = #{localImagePath},
            status                = #{status},
            update_time           = sysdate()
        where id = #{id}
    </update>

</mapper>
