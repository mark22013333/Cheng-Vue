#!/bin/bash

# Git Commit Message æ ¼å¼é©—è­‰
# æ ¹æ“šåœ˜éšŠè¦ç¯„æª¢æŸ¥ commit message æ ¼å¼

set -e

# å–å¾— commit message æª”æ¡ˆè·¯å¾‘
COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# é¡è‰²å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo ""
echo -e "${BLUE}ğŸ” æª¢æŸ¥ Commit Message æ ¼å¼...${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# è·³é merge commit
if echo "$COMMIT_MSG" | grep -q "^Merge"; then
    echo -e "${GREEN}âœ… Merge commitï¼Œè·³éæ ¼å¼æª¢æŸ¥${NC}"
    echo ""
    exit 0
fi

# è·³é revert commit
if echo "$COMMIT_MSG" | grep -q "^Revert"; then
    echo -e "${GREEN}âœ… Revert commitï¼Œè·³éæ ¼å¼æª¢æŸ¥${NC}"
    echo ""
    exit 0
fi

# å®šç¾©å…è¨±çš„ prefixï¼ˆæ”¯æ´å¯é¸çš„ scopeï¼‰
# æ ¼å¼ï¼šprefix: message æˆ– prefix(scope): message
VALID_PREFIXES="^(feat|fix|docs|style|refactor|perf|test|chore|build|ci|revert)(\([a-zA-Z0-9_-]+\))?:"

# æª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ prefix
if ! echo "$COMMIT_MSG" | grep -qE "$VALID_PREFIXES"; then
    echo -e "${RED}âŒ Commit message æ ¼å¼éŒ¯èª¤ï¼${NC}"
    echo ""
    echo -e "${YELLOW}å¿…é ˆä½¿ç”¨ä»¥ä¸‹å…¶ä¸­ä¸€å€‹ prefixï¼š${NC}"
    echo "  - feat:     æ–°å¢åŠŸèƒ½"
    echo "  - fix:      ä¿®æ­£ Bug"
    echo "  - docs:     æ–‡ä»¶è®Šæ›´"
    echo "  - style:    ç¨‹å¼ç¢¼æ ¼å¼èª¿æ•´ï¼ˆä¸å½±éŸ¿åŠŸèƒ½ï¼‰"
    echo "  - refactor: é‡æ§‹ç¨‹å¼ç¢¼"
    echo "  - perf:     æ•ˆèƒ½å„ªåŒ–"
    echo "  - test:     æ¸¬è©¦ç›¸é—œ"
    echo "  - chore:    é›œé …ï¼ˆå»ºç½®ã€å·¥å…·ç­‰ï¼‰"
    echo "  - build:    å»ºç½®ç³»çµ±è®Šæ›´"
    echo "  - ci:       CI/CD é…ç½®è®Šæ›´"
    echo ""
    echo -e "${YELLOW}ç¯„ä¾‹æ ¼å¼ï¼š${NC}"
    echo "  feat: æ–°å¢ä½¿ç”¨è€…ç™»å…¥åŠŸèƒ½"
    echo "  feat(auth): æ–°å¢ JWT Token é©—è­‰"
    echo "  fix(system): ä¿®æ­£é¸å–®æ¬Šé™æª¢æŸ¥å•é¡Œ"
    echo ""
    echo "  fix: ä¿®æ­£é˜¿ç”˜é ­åƒå¯èƒ½è¢«è¦†è“‹çš„å•é¡Œ"
    echo ""
    echo "  LINEBotApi.java - ä¿®æ­£è‹¥ç‚ºé˜¿ç”˜å‚³é€çš„é ­åƒï¼Œä¸èƒ½å¥—ç”¨å¾Œå°è¨­å®šçš„é ­åƒ"
    echo "  AuthController.java - è£œä¸Šæ¨æ’­åŠŸèƒ½æ‰€éœ€çš„ sender åƒæ•¸"
    echo ""
    echo -e "${YELLOW}ç›®å‰çš„ commit messageï¼š${NC}"
    echo "$COMMIT_MSG"
    echo ""
    echo -e "${BLUE}å¦‚éœ€è·³éæª¢æŸ¥ï¼Œè«‹ä½¿ç”¨ï¼š${NC}"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi

# æå– prefix å’Œæ¨™é¡Œï¼ˆæ”¯æ´ scopeï¼‰
PREFIX=$(echo "$COMMIT_MSG" | head -n 1 | sed -E 's/^([a-z]+)(\([a-zA-Z0-9_-]+\))?:.*/\1/')
SCOPE=$(echo "$COMMIT_MSG" | head -n 1 | sed -E 's/^[a-z]+\(([a-zA-Z0-9_-]+)\):.*/\1/')
TITLE=$(echo "$COMMIT_MSG" | head -n 1 | sed -E 's/^[a-z]+(\([a-zA-Z0-9_-]+\))?:\s*//')

# æª¢æŸ¥æ¨™é¡Œæ˜¯å¦ç‚ºç©º
if [ -z "$TITLE" ]; then
    echo -e "${RED}âŒ Commit message æ¨™é¡Œä¸èƒ½ç‚ºç©ºï¼${NC}"
    echo ""
    echo -e "${YELLOW}æ­£ç¢ºæ ¼å¼ï¼š${NC}"
    echo "  prefix: æ¨™é¡Œ"
    echo ""
    echo "  è©³ç´°èªªæ˜ï¼ˆå¯é¸ï¼‰"
    echo ""
    exit 1
fi

# æª¢æŸ¥æ¨™é¡Œé•·åº¦ï¼ˆå»ºè­°ä¸è¶…é 72 å­—å…ƒï¼‰
TITLE_LENGTH=${#TITLE}
if [ $TITLE_LENGTH -gt 72 ]; then
    echo -e "${YELLOW}âš ï¸  æ¨™é¡Œéé•·ï¼ˆ${TITLE_LENGTH} å­—å…ƒï¼Œå»ºè­° < 72ï¼‰${NC}"
    echo "  å»ºè­°å°‡è©³ç´°èªªæ˜ç§»åˆ°ç¬¬äºŒæ®µ"
    echo ""
fi

# æ‰€æœ‰æª¢æŸ¥é€šé
echo -e "${GREEN}âœ… Commit message æ ¼å¼æ­£ç¢º${NC}"
echo ""
echo -e "${BLUE}Prefix:${NC} ${PREFIX}"
# åªåœ¨æœ‰ scope æ™‚é¡¯ç¤º
if [ "$SCOPE" != "$COMMIT_MSG" ] && [ -n "$SCOPE" ]; then
    echo -e "${BLUE}Scope:${NC} ${SCOPE}"
fi
echo -e "${BLUE}æ¨™é¡Œ:${NC} ${TITLE}"

# é¡¯ç¤ºå®Œæ•´è¨Šæ¯ï¼ˆå¦‚æœæœ‰å¤šè¡Œï¼‰
LINE_COUNT=$(echo "$COMMIT_MSG" | wc -l | tr -d ' ')
if [ "$LINE_COUNT" -gt 1 ]; then
    echo ""
    echo -e "${BLUE}å®Œæ•´è¨Šæ¯ï¼š${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "$COMMIT_MSG"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
fi

echo ""
exit 0
