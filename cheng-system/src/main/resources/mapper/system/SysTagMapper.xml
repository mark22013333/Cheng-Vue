<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cheng.system.mapper.SysTagMapper">

    <resultMap type="com.cheng.system.domain.SysTag" id="SysTagResult">
        <id     property="tagId"          column="tag_id"/>
        <result property="tagName"        column="tag_name"/>
        <result property="tagCode"        column="tag_code"/>
        <result property="tagColor"       column="tag_color"/>
        <result property="tagDescription" column="tag_description"/>
        <result property="platformScope"  column="platform_scope"/>
        <result property="userCount"      column="user_count"/>
        <result property="itemCount"      column="item_count"/>
        <result property="status"         column="status"/>
        <result property="sortOrder"      column="sort_order"/>
        <result property="createBy"       column="create_by"/>
        <result property="createTime"     column="create_time"/>
        <result property="updateBy"       column="update_by"/>
        <result property="updateTime"     column="update_time"/>
        <result property="remark"         column="remark"/>
    </resultMap>

    <sql id="selectSysTagVo">
        select tag_id, tag_name, tag_code, tag_color, tag_description, platform_scope,
               user_count, item_count, status, sort_order, create_by, create_time,
               update_by, update_time, remark
        from sys_tag
    </sql>

    <select id="selectSysTagByTagId" parameterType="Long" resultMap="SysTagResult">
        <include refid="selectSysTagVo"/>
        where tag_id = #{tagId}
    </select>

    <select id="selectSysTagByTagCode" parameterType="String" resultMap="SysTagResult">
        <include refid="selectSysTagVo"/>
        where tag_code = #{tagCode}
    </select>

    <select id="selectSysTagList" parameterType="com.cheng.system.domain.SysTag" resultMap="SysTagResult">
        <include refid="selectSysTagVo"/>
        <where>
            <if test="tagName != null and tagName != ''">
                AND tag_name like concat('%', #{tagName}, '%')
            </if>
            <if test="tagCode != null and tagCode != ''">
                AND tag_code like concat('%', #{tagCode}, '%')
            </if>
            <if test="platformScope != null and platformScope != ''">
                AND (platform_scope = 'ALL' OR platform_scope like concat('%', #{platformScope}, '%'))
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
        order by sort_order asc, tag_id asc
    </select>

    <select id="selectSysTagListByPlatform" resultMap="SysTagResult">
        <include refid="selectSysTagVo"/>
        <where>
            <if test="platformScope != null and platformScope != ''">
                AND (platform_scope = 'ALL' OR platform_scope like concat('%', #{platformScope}, '%'))
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
        order by sort_order asc, tag_id asc
    </select>

    <select id="checkTagCodeUnique" parameterType="String" resultMap="SysTagResult">
        <include refid="selectSysTagVo"/>
        where tag_code = #{tagCode} limit 1
    </select>

    <select id="selectByNameAndPlatform" resultMap="SysTagResult">
        <include refid="selectSysTagVo"/>
        where tag_name = #{tagName} and platform_scope = #{platformScope} limit 1
    </select>

    <insert id="insertSysTag" parameterType="com.cheng.system.domain.SysTag" useGeneratedKeys="true" keyProperty="tagId">
        insert into sys_tag
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="tagName != null and tagName != ''">tag_name,</if>
            <if test="tagCode != null and tagCode != ''">tag_code,</if>
            <if test="tagColor != null">tag_color,</if>
            <if test="tagDescription != null">tag_description,</if>
            <if test="platformScope != null">platform_scope,</if>
            <if test="userCount != null">user_count,</if>
            <if test="itemCount != null">item_count,</if>
            <if test="status != null">status,</if>
            <if test="sortOrder != null">sort_order,</if>
            <if test="createBy != null and createBy != ''">create_by,</if>
            <if test="remark != null">remark,</if>
            create_time
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="tagName != null and tagName != ''">#{tagName},</if>
            <if test="tagCode != null and tagCode != ''">#{tagCode},</if>
            <if test="tagColor != null">#{tagColor},</if>
            <if test="tagDescription != null">#{tagDescription},</if>
            <if test="platformScope != null">#{platformScope},</if>
            <if test="userCount != null">#{userCount},</if>
            <if test="itemCount != null">#{itemCount},</if>
            <if test="status != null">#{status},</if>
            <if test="sortOrder != null">#{sortOrder},</if>
            <if test="createBy != null and createBy != ''">#{createBy},</if>
            <if test="remark != null">#{remark},</if>
            sysdate()
        </trim>
    </insert>

    <update id="updateSysTag" parameterType="com.cheng.system.domain.SysTag">
        update sys_tag
        <trim prefix="SET" suffixOverrides=",">
            <if test="tagName != null and tagName != ''">tag_name = #{tagName},</if>
            <if test="tagColor != null">tag_color = #{tagColor},</if>
            <if test="tagDescription != null">tag_description = #{tagDescription},</if>
            <if test="platformScope != null">platform_scope = #{platformScope},</if>
            <if test="userCount != null">user_count = #{userCount},</if>
            <if test="itemCount != null">item_count = #{itemCount},</if>
            <if test="status != null">status = #{status},</if>
            <if test="sortOrder != null">sort_order = #{sortOrder},</if>
            <if test="updateBy != null and updateBy != ''">update_by = #{updateBy},</if>
            <if test="remark != null">remark = #{remark},</if>
            update_time = sysdate()
        </trim>
        where tag_id = #{tagId}
    </update>

    <delete id="deleteSysTagByTagId" parameterType="Long">
        delete from sys_tag where tag_id = #{tagId}
    </delete>

    <delete id="deleteSysTagByTagIds" parameterType="Long">
        delete from sys_tag where tag_id in
        <foreach collection="array" item="tagId" open="(" separator="," close=")">
            #{tagId}
        </foreach>
    </delete>

    <update id="updateUserCount">
        update sys_tag set user_count = #{userCount}, update_time = sysdate() where tag_id = #{tagId}
    </update>

    <update id="updateItemCount">
        update sys_tag set item_count = #{itemCount}, update_time = sysdate() where tag_id = #{tagId}
    </update>

    <update id="recalculateAllUserCounts">
        update sys_tag t
        set t.user_count = (
            select count(*) from line_user_tag_relation r where r.tag_id = t.tag_id
        ),
        t.update_time = sysdate()
        where t.platform_scope = 'ALL' or t.platform_scope like '%LINE%'
    </update>

    <update id="recalculateAllItemCounts">
        update sys_tag t
        set t.item_count = (
            select count(*) from inv_item_tag_relation r where r.tag_id = t.tag_id
        ),
        t.update_time = sysdate()
        where t.platform_scope = 'ALL' or t.platform_scope like '%INVENTORY%'
    </update>

    <select id="selectByTagNames" resultMap="SysTagResult">
        <include refid="selectSysTagVo"/>
        where tag_name in
        <foreach collection="tagNames" item="name" open="(" separator="," close=")">
            #{name}
        </foreach>
    </select>

</mapper>
