<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cheng.system.mapper.InvScanLogMapper">
    
    <resultMap type="InvScanLog" id="InvScanLogResult">
        <result property="scanId"    column="scan_id"    />
        <result property="itemId"    column="item_id"    />
        <result property="itemCode"    column="item_code"    />
        <result property="itemName"    column="item_name"    />
        <result property="scanType"    column="scan_type"    />
        <result property="scanCode"    column="scan_code"    />
        <result property="scanResult"    column="scan_result"    />
        <result property="scanTime"    column="scan_time"    />
        <result property="scannerId"    column="scanner_id"    />
        <result property="scannerName"    column="scanner_name"    />
        <result property="scanDevice"    column="scan_device"    />
        <result property="scanLocation"    column="scan_location"    />
        <result property="failReason"    column="fail_reason"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
        <result property="remark"    column="remark"    />
    </resultMap>

    <sql id="selectInvScanLogVo">
        select s.scan_id, s.item_id, i.item_code, i.item_name, s.scan_type, s.scan_code, s.scan_result, 
               s.scan_time, s.scanner_id, s.scanner_name, s.scan_device, s.scan_location, s.fail_reason,
               s.create_by, s.create_time, s.update_by, s.update_time, s.remark 
        from inv_scan_log s
        left join inv_item i on s.item_id = i.item_id
    </sql>

    <select id="selectInvScanLogList" parameterType="InvScanLog" resultMap="InvScanLogResult">
        <include refid="selectInvScanLogVo"/>
        <where>  
            <if test="itemCode != null and itemCode != ''"> and i.item_code like concat('%', #{itemCode}, '%')</if>
            <if test="itemName != null and itemName != ''"> and i.item_name like concat('%', #{itemName}, '%')</if>
            <if test="scanType != null and scanType != ''"> and s.scan_type = #{scanType}</if>
            <if test="scanCode != null and scanCode != ''"> and s.scan_code like concat('%', #{scanCode}, '%')</if>
            <if test="scanResult != null and scanResult != ''"> and s.scan_result = #{scanResult}</if>
            <if test="scannerName != null and scannerName != ''"> and s.scanner_name like concat('%', #{scannerName}, '%')</if>
            <if test="params.beginScanTime != null and params.beginScanTime != ''"><!-- 開始掃描時間 -->
                and date_format(s.scan_time,'%y%m%d') &gt;= date_format(#{params.beginScanTime},'%y%m%d')
            </if>
            <if test="params.endScanTime != null and params.endScanTime != ''"><!-- 結束掃描時間 -->
                and date_format(s.scan_time,'%y%m%d') &lt;= date_format(#{params.endScanTime},'%y%m%d')
            </if>
        </where>
        order by s.scan_time desc
    </select>
    
    <select id="selectInvScanLogByScanId" parameterType="Long" resultMap="InvScanLogResult">
        <include refid="selectInvScanLogVo"/>
        where s.scan_id = #{scanId}
    </select>

    <select id="selectInvScanLogByItemId" parameterType="Long" resultMap="InvScanLogResult">
        <include refid="selectInvScanLogVo"/>
        where s.item_id = #{itemId}
        order by s.scan_time desc
    </select>

    <select id="selectInvScanLogByScannerId" parameterType="Long" resultMap="InvScanLogResult">
        <include refid="selectInvScanLogVo"/>
        where s.scanner_id = #{scannerId}
        order by s.scan_time desc
    </select>

    <select id="selectInvScanLogByScanResult" parameterType="String" resultMap="InvScanLogResult">
        <include refid="selectInvScanLogVo"/>
        where s.scan_result = #{scanResult}
        order by s.scan_time desc
    </select>

    <select id="selectScanStatistics" resultType="java.util.Map">
        select 
            count(*) as totalScans,
            sum(case when scan_result = '0' then 1 else 0 end) as successScans,
            sum(case when scan_result = '1' then 1 else 0 end) as failScans,
            sum(case when scan_type = '1' then 1 else 0 end) as barcodeScans,
            sum(case when scan_type = '2' then 1 else 0 end) as qrcodeScans
        from inv_scan_log
        where scan_time >= date_sub(now(), interval 30 day)
    </select>
        
    <insert id="insertInvScanLog" parameterType="InvScanLog" useGeneratedKeys="true" keyProperty="scanId">
        insert into inv_scan_log
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="itemId != null">item_id,</if>
            <if test="scanType != null and scanType != ''">scan_type,</if>
            <if test="scanCode != null and scanCode != ''">scan_code,</if>
            <if test="scanResult != null and scanResult != ''">scan_result,</if>
            <if test="scanTime != null">scan_time,</if>
            <if test="scannerId != null">scanner_id,</if>
            <if test="scannerName != null and scannerName != ''">scanner_name,</if>
            <if test="scanDevice != null">scan_device,</if>
            <if test="scanLocation != null">scan_location,</if>
            <if test="failReason != null">fail_reason,</if>
            <if test="createBy != null">create_by,</if>
            <if test="createTime != null">create_time,</if>
            <if test="updateBy != null">update_by,</if>
            <if test="updateTime != null">update_time,</if>
            <if test="remark != null">remark,</if>
         </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="itemId != null">#{itemId},</if>
            <if test="scanType != null and scanType != ''">#{scanType},</if>
            <if test="scanCode != null and scanCode != ''">#{scanCode},</if>
            <if test="scanResult != null and scanResult != ''">#{scanResult},</if>
            <if test="scanTime != null">#{scanTime},</if>
            <if test="scannerId != null">#{scannerId},</if>
            <if test="scannerName != null and scannerName != ''">#{scannerName},</if>
            <if test="scanDevice != null">#{scanDevice},</if>
            <if test="scanLocation != null">#{scanLocation},</if>
            <if test="failReason != null">#{failReason},</if>
            <if test="createBy != null">#{createBy},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="updateBy != null">#{updateBy},</if>
            <if test="updateTime != null">#{updateTime},</if>
            <if test="remark != null">#{remark},</if>
         </trim>
    </insert>

    <update id="updateInvScanLog" parameterType="InvScanLog">
        update inv_scan_log
        <trim prefix="SET" suffixOverrides=",">
            <if test="itemId != null">item_id = #{itemId},</if>
            <if test="scanType != null and scanType != ''">scan_type = #{scanType},</if>
            <if test="scanCode != null and scanCode != ''">scan_code = #{scanCode},</if>
            <if test="scanResult != null and scanResult != ''">scan_result = #{scanResult},</if>
            <if test="scanTime != null">scan_time = #{scanTime},</if>
            <if test="scannerId != null">scanner_id = #{scannerId},</if>
            <if test="scannerName != null and scannerName != ''">scanner_name = #{scannerName},</if>
            <if test="scanDevice != null">scan_device = #{scanDevice},</if>
            <if test="scanLocation != null">scan_location = #{scanLocation},</if>
            <if test="failReason != null">fail_reason = #{failReason},</if>
            <if test="createBy != null">create_by = #{createBy},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="remark != null">remark = #{remark},</if>
        </trim>
        where scan_id = #{scanId}
    </update>

    <delete id="deleteInvScanLogByScanId" parameterType="Long">
        delete from inv_scan_log where scan_id = #{scanId}
    </delete>

    <delete id="deleteInvScanLogByScanIds" parameterType="String">
        delete from inv_scan_log where scan_id in 
        <foreach item="scanId" collection="array" open="(" separator="," close=")">
            #{scanId}
        </foreach>
    </delete>

    <delete id="clearHistoryScanLog" parameterType="int">
        delete from inv_scan_log 
        where scan_time &lt; date_sub(now(), interval #{days} day)
    </delete>

</mapper>
